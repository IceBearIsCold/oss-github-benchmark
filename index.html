<html>
  <head>
    <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"
    ></script>
    <style>
      div.tooltip {
        position: absolute;
        text-align: center;
        padding: 5px;
        background: lightskyblue;
        border-radius: 2px;
        font: 10px sans-serif;
      }
      .axis path,
      .axis line {
        fill: none;
        stroke: grey;
        stroke-width: 1;
        shape-rendering: crispEdges;
      }
      svg circle {
        stroke: white;
        opacity: 0.8;
        stroke-opacity: 0.5;
      }
    </style>
  </head>

  <body>
    <script>
      var width = window.innerWidth;
      var height = window.innerHeight;
      var padding = 70;

      var institutions = [];
      d3.csv("oss-github-benchmark.csv", data => {
        institutions.push(data);
      }).then(() => {
        // var data = [10, 20, 30];
        console.log(institutions);
        institutions.sort(
          (a, b) => parseInt(b.num_members) - parseInt(a.num_members)
        );
        var colors = ["green", "purple", "yellow"];

        var num_repos = institution => parseInt(institution.num_repos);
        var members = institution => parseInt(institution.num_members);
        var contributors = i => parseInt(i.total_num_contributors);
        var sector = i => i.sector;

        var yscale = d3
          .scaleLinear()
          .domain([
            d3.min(institutions.map(num_repos)),
            d3.max(institutions.map(num_repos))
          ])
          .range([height - padding, padding]);

        var yAxis = d3
          .axisLeft()
          .scale(yscale)
          .ticks(5);

        var xscale = d3
          .scaleLinear()
          .domain([
            d3.min(institutions.map(contributors)),
            d3.max(institutions.map(contributors))
          ])
          .range([padding, width - padding]);

        var xAxis = d3
          .axisBottom()
          .scale(xscale)
          .ticks(5);
        // var xscale = d3.scaleBand(institutions.map(i => i.name), [20, 270]);

        var colorScale = d3.scaleOrdinal(
          _.uniq(institutions.map(sector)),
          d3.schemePaired
        );

        var sizeScale = d3
          .scaleLinear()
          .domain([
            d3.min(institutions.map(members)),
            d3.max(institutions.map(members))
          ])
          .range([4, 30]);

        var svg = d3
          .select("body")
          .append("svg")
          .attr("width", width)
          .attr("height", height);

        var text = d3
          .select("body")
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", "0");

        var g = svg
          .selectAll("g")
          .data(institutions)
          .enter()
          .append("g")
          .attr("transform", function(d, i) {
            return "translate(0,0)";
          });

        g.append("circle")

          .attr("cx", function(inst, i) {
            return xscale(contributors(inst));
          })

          .attr("cy", function(inst, i) {
            return yscale(parseInt(inst.num_repos));
          })

          .attr("r", function(inst) {
            return sizeScale(members(inst));
          })

          .attr("svg:title", inst => inst.name)

          .attr("fill", function(inst, i) {
            return colorScale(inst.sector);
          })
          .on("click", inst => {
            window.open("https://github.com/" + orgs[0], "_blank");
          })
          .on("mouseover", inst => {
            var img = eval(inst.avatar)[0];
            text
              .html(
                `<img src="${img}" height=25 ><br>
                ${inst.name}<br>
                  Repos: ${inst.num_repos}<br>
                  Contributors: ${inst.total_num_contributors}<br>
                  Members: ${inst.num_members}`
              )
              .style("display", "block")

              .style(
                "top",
                yscale(parseInt(inst.num_repos)) - sizeScale(members(inst))
              )
              //   .transition()
              //   .duration(200)
              .style("opacity", 0.8);
            if (xscale(contributors(inst)) > width / 2) {
              text
                .style(
                  "right",
                  width -
                    (xscale(contributors(inst)) + sizeScale(members(inst)))
                )
                .style("left", undefined);
            } else {
              text
                .style(
                  "left",
                  xscale(contributors(inst)) + sizeScale(members(inst))
                )
                .style("right", undefined);
            }
          })
          .on("mouseout", inst => {
            text.style("opacity", 0).style("display", "none");
          });

        svg
          .append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + (height - padding) + ")")
          .call(xAxis);

        svg
          .append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + padding + ",0)")
          .call(yAxis);
        // g.append("text")
        //   .attr("x", function(inst, i) {
        //     return xscale(contributors(inst));
        //   })

        //   .attr("y", function(inst, i) {
        //     return yscale(parseInt(inst.num_repos));
        //   })

        //   .attr("stroke", "teal")
        //   .attr("hidden", true)
        //   .attr("font-size", "10px")
        //   .attr("font-family", "sans-serif")
        //   .text(inst => inst.name);
      });
    </script>
  </body>
</html>
